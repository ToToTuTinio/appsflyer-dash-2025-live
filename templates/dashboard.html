console.log("Chart.js loaded?", !!window.Chart);

function renderChartWithRetry(canvasId, renderFn, retries = 30) {
    const el = document.getElementById(canvasId);
    if (el && window.Chart) {
        if (window.statsCharts[canvasId]) {
            window.statsCharts[canvasId].destroy();
        }
        try {
            window.statsCharts[canvasId] = renderFn(el);
        } catch (e) {
            console.error("Chart.js error for " + canvasId + ":", e);
        }
    } else if (retries > 0) {
        setTimeout(() => renderChartWithRetry(canvasId, renderFn, retries - 1), 200);
    } else {
        if (!el) {
            console.warn("Canvas not found for", canvasId);
        } else if (!window.Chart) {
            console.warn("Chart.js not loaded for", canvasId);
        } else {
            console.warn("Failed to render chart for", canvasId);
        }
    }
}

window.statsCharts = {};

function renderStatsAppsForRange(apps, range) {
    const container = document.getElementById('stats-apps-container');
    if (!container) {
        console.error('stats-apps-container not found in DOM!');
        return;
    }
    // Destroy all previous charts
    if (window.statsCharts) {
        Object.values(window.statsCharts).forEach(chart => {
            if (chart && typeof chart.destroy === 'function') chart.destroy();
        });
        window.statsCharts = {};
    }

    container.innerHTML = '';
    apps.forEach(app => {
        let safeName = app.app_name.replace(/\W/g, "");
        let mainId = `trend-main-${app.app_id}-${safeName}`;
        let eventsId = `trend-events-${app.app_id}-${safeName}`;
        let fraudId = `trend-fraud-${app.app_id}-${safeName}`;
        let section = document.createElement('div');
        section.className = 'app-section';
        section.innerHTML = `
            <h3>${app.app_name}</h3>
            <div class="chart-container">
                <h4>Impressions & Clicks</h4>
                <canvas id="${mainId}"></canvas>
            </div>
            <div class="chart-container">
                <h4>Installs & Events</h4>
                <canvas id="${eventsId}"></canvas>
            </div>
            <div class="chart-container">
                <h4>Fraud: Blocked Installs</h4>
                <canvas id="${fraudId}"></canvas>
            </div>
        `;
        container.appendChild(section);
    });

    apps.forEach(app => {
        let safeName = app.app_name.replace(/\W/g, "");
        let mainId = `trend-main-${app.app_id}-${safeName}`;
        let eventsId = `trend-events-${app.app_id}-${safeName}`;
        let fraudId = `trend-fraud-${app.app_id}-${safeName}`;

        // Defensive: log data and check for empty arrays
        if (!app.dates || app.dates.length === 0) {
            console.warn("No dates for app", app.app_name);
        }
        if (!app.impressions || app.impressions.length === 0) {
            console.warn("No impressions for app", app.app_name);
        }
        if (!app.clicks || app.clicks.length === 0) {
            console.warn("No clicks for app", app.app_name);
        }
        if (!app.installs || app.installs.length === 0) {
            console.warn("No installs for app", app.app_name);
        }
        if (!app.events || app.events.length === 0) {
            console.warn("No events for app", app.app_name);
        }
        if (!app.blocked_installs || app.blocked_installs.length === 0) {
            console.warn("No blocked_installs for app", app.app_name);
        }

        renderChartWithRetry(mainId, (el) => {
            return new Chart(el, {
                type: 'line',
                data: {
                    labels: app.dates,
                    datasets: [
                        { label: 'Impressions', data: app.impressions, borderColor: 'blue' },
                        { label: 'Clicks', data: app.clicks, borderColor: 'green' }
                    ]
                }
            });
        });
        renderChartWithRetry(eventsId, (el) => {
            return new Chart(el, {
                type: 'line',
                data: {
                    labels: app.dates,
                    datasets: [
                        { label: 'Installs', data: app.installs, borderColor: 'red' },
                        { label: 'Events', data: app.events, borderColor: 'orange' }
                    ]
                }
            });
        });
        renderChartWithRetry(fraudId, (el) => {
            return new Chart(el, {
                type: 'line',
                data: {
                    labels: app.dates,
                    datasets: [
                        { label: 'Blocked Installs', data: app.blocked_installs, borderColor: 'purple' }
                    ]
                }
            });
        });
    });
} 