console.log("Chart.js loaded?", !!window.Chart);

function renderChartWithRetry(canvasId, renderFn, retries = 30) {
    const el = document.getElementById(canvasId);
    if (el && window.Chart) {
        if (el.chartInstance) {
            el.chartInstance.destroy();
        }
        try {
            el.chartInstance = renderFn(el);
        } catch (e) {
            console.error("Chart.js error for " + canvasId + ":", e);
        }
    } else if (retries > 0) {
        setTimeout(() => renderChartWithRetry(canvasId, renderFn, retries - 1), 200);
    } else {
        console.warn("Failed to render chart for", canvasId);
    }
}

window.statsCharts = {};

function renderStatsAppsForRange(apps, range) {
    // Destroy all previous charts
    if (window.statsCharts) {
        Object.values(window.statsCharts).forEach(chart => {
            if (chart && typeof chart.destroy === 'function') chart.destroy();
        });
        window.statsCharts = {};
    }

    const container = document.getElementById('stats-apps-container');
    container.innerHTML = '';
    apps.forEach(app => {
        let safeName = app.app_name.replace(/\W/g, "");
        let mainId = `trend-main-${app.app_id}-${safeName}`;
        let eventsId = `trend-events-${app.app_id}-${safeName}`;
        let fraudId = `trend-fraud-${app.app_id}-${safeName}`;
        let section = document.createElement('div');
        section.className = 'app-section';
        section.innerHTML = `
            <h3>${app.app_name}</h3>
            <div class="chart-container">
                <h4>Impressions & Clicks</h4>
                <canvas id="${mainId}"></canvas>
            </div>
            <div class="chart-container">
                <h4>Installs & Events</h4>
                <canvas id="${eventsId}"></canvas>
            </div>
            <div class="chart-container">
                <h4>Fraud: Blocked Installs</h4>
                <canvas id="${fraudId}"></canvas>
            </div>
        `;
        container.appendChild(section);
    });

    setTimeout(() => {
        apps.forEach(app => {
            let safeName = app.app_name.replace(/\W/g, "");
            let mainId = `trend-main-${app.app_id}-${safeName}`;
            let eventsId = `trend-events-${app.app_id}-${safeName}`;
            let fraudId = `trend-fraud-${app.app_id}-${safeName}`;

            if (document.getElementById(mainId)) {
                window.statsCharts[mainId] = new Chart(document.getElementById(mainId), {
                    type: 'line',
                    data: {
                        labels: app.dates,
                        datasets: [
                            { label: 'Impressions', data: app.impressions, borderColor: 'blue' },
                            { label: 'Clicks', data: app.clicks, borderColor: 'green' }
                        ]
                    }
                });
            }
            if (document.getElementById(eventsId)) {
                window.statsCharts[eventsId] = new Chart(document.getElementById(eventsId), {
                    type: 'line',
                    data: {
                        labels: app.dates,
                        datasets: [
                            { label: 'Installs', data: app.installs, borderColor: 'red' },
                            { label: 'Events', data: app.events, borderColor: 'orange' }
                        ]
                    }
                });
            }
            if (document.getElementById(fraudId)) {
                window.statsCharts[fraudId] = new Chart(document.getElementById(fraudId), {
                    type: 'line',
                    data: {
                        labels: app.dates,
                        datasets: [
                            { label: 'Blocked Installs', data: app.blocked_installs, borderColor: 'purple' }
                        ]
                    }
                });
            }
        });
    }, 500);
} 