function renderChartWithRetry(canvasId, renderFn, retries = 30) {
    const el = document.getElementById(canvasId);
    if (el && window.Chart) {
        try {
            renderFn(el);
        } catch (e) {
            console.error("Chart.js error for " + canvasId + ":", e);
        }
    } else if (retries > 0) {
        setTimeout(() => renderChartWithRetry(canvasId, renderFn, retries - 1), 200);
    } else {
        console.warn("Failed to render chart for", canvasId);
    }
}

function renderStatsAppsForRange(apps, range) {
    const container = document.getElementById('stats-apps-container');
    container.innerHTML = '';
    apps.forEach(app => {
        let safeName = app.app_name.replace(/\W/g, "");
        let mainId = `trend-main-${app.app_id}-${safeName}`;
        let eventsId = `trend-events-${app.app_id}-${safeName}`;
        let fraudId = `trend-fraud-${app.app_id}-${safeName}`;
        let section = document.createElement('div');
        section.className = 'app-section';
        section.innerHTML = `
            <h3>${app.app_name}</h3>
            <div class="chart-container">
                <h4>Impressions & Clicks</h4>
                <canvas id="${mainId}"></canvas>
            </div>
            <div class="chart-container">
                <h4>Installs & Events</h4>
                <canvas id="${eventsId}"></canvas>
            </div>
            <div class="chart-container">
                <h4>Fraud: Blocked Installs</h4>
                <canvas id="${fraudId}"></canvas>
            </div>
        `;
        container.appendChild(section);
    });
    // Force re-render of all charts after a delay to ensure DOM is ready
    setTimeout(() => {
        apps.forEach(app => {
            let safeName = app.app_name.replace(/\W/g, "");
            let mainId = `trend-main-${app.app_id}-${safeName}`;
            let eventsId = `trend-events-${app.app_id}-${safeName}`;
            let fraudId = `trend-fraud-${app.app_id}-${safeName}`;
            renderChartWithRetry(mainId, (el) => {
                new Chart(el, {
                    type: 'line',
                    data: {
                        labels: app.dates,
                        datasets: [
                            { label: 'Impressions', data: app.impressions, borderColor: 'blue' },
                            { label: 'Clicks', data: app.clicks, borderColor: 'green' }
                        ]
                    }
                });
            });
            renderChartWithRetry(eventsId, (el) => {
                new Chart(el, {
                    type: 'line',
                    data: {
                        labels: app.dates,
                        datasets: [
                            { label: 'Installs', data: app.installs, borderColor: 'red' },
                            { label: 'Events', data: app.events, borderColor: 'orange' }
                        ]
                    }
                });
            });
            renderChartWithRetry(fraudId, (el) => {
                new Chart(el, {
                    type: 'line',
                    data: {
                        labels: app.dates,
                        datasets: [
                            { label: 'Blocked Installs', data: app.blocked_installs, borderColor: 'purple' }
                        ]
                    }
                });
            });
        });
    }, 500);
} 