console.log("Chart.js loaded?", !!window.Chart);

function renderChartWithRetry(canvasId, renderFn, retries = 150) {
    const el = document.getElementById(canvasId);
    if (el && window.Chart) {
        if (window.statsCharts[canvasId]) {
            window.statsCharts[canvasId].destroy();
            console.log(`Destroyed previous chart for ${canvasId}`);
        }
        try {
            window.statsCharts[canvasId] = renderFn(el);
            console.log(`Created chart for ${canvasId}`);
        } catch (e) {
            console.error("Chart.js error for " + canvasId + ":", e);
        }
    } else if (retries > 0) {
        setTimeout(() => renderChartWithRetry(canvasId, renderFn, retries - 1), 1000);
    } else {
        if (!el) {
            console.warn("Canvas not found for", canvasId);
        } else if (!window.Chart) {
            console.warn("Chart.js not loaded for", canvasId);
        } else {
            console.warn("Failed to render chart for", canvasId);
        }
    }
}

window.statsCharts = {};

function destroyAllStatsCharts() {
    if (window.statsCharts) {
        Object.values(window.statsCharts).forEach(chart => {
            if (chart && typeof chart.destroy === 'function') {
                chart.destroy();
            }
        });
        window.statsCharts = {};
        console.log('Destroyed all stats charts');
    }
}

function renderStatsAppsForRange(range, apps) {
    const container = document.getElementById(`stats-data-${range}`);
    if (!container) {
        console.error('Stats container not found for range:', range);
        return;
    }
    destroyAllStatsCharts();
    container.innerHTML = '';
    if (!apps || !apps.length) {
        container.innerHTML = '<div class="text-gray-500">No data available for this range.</div>';
        return;
    }
    apps.forEach(app => {
        let safeName = app.app_name.replace(/\W/g, "");
        let mainId = `trend-main-${app.app_id}-${safeName}`;
        let eventsId = `trend-events-${app.app_id}-${safeName}`;
        let fraudId = `trend-fraud-${app.app_id}-${safeName}`;
        let section = document.createElement('div');
        section.className = 'app-section';
        section.innerHTML = `
            <h3>${app.app_name}</h3>
            <div class=\"chart-container\">
                <h4>Impressions & Clicks</h4>
                <canvas id=\"${mainId}\"></canvas>
            </div>
            <div class=\"chart-container\">
                <h4>Installs & Events</h4>
                <canvas id=\"${eventsId}\"></canvas>
            </div>
            <div class=\"chart-container\">
                <h4>Fraud: Blocked Installs</h4>
                <canvas id=\"${fraudId}\"></canvas>
            </div>
        `;
        container.appendChild(section);
    });
    apps.forEach(app => {
        let safeName = app.app_name.replace(/\W/g, "");
        let mainId = `trend-main-${app.app_id}-${safeName}`;
        let eventsId = `trend-events-${app.app_id}-${safeName}`;
        let fraudId = `trend-fraud-${app.app_id}-${safeName}`;
        renderChartWithRetry(mainId, (el) => {
            return new Chart(el, {
                type: 'line',
                data: {
                    labels: app.dates,
                    datasets: [
                        { label: 'Impressions', data: app.impressions, borderColor: 'blue' },
                        { label: 'Clicks', data: app.clicks, borderColor: 'green' }
                    ]
                }
            });
        });
        renderChartWithRetry(eventsId, (el) => {
            return new Chart(el, {
                type: 'line',
                data: {
                    labels: app.dates,
                    datasets: [
                        { label: 'Installs', data: app.installs, borderColor: 'red' },
                        { label: 'Events', data: app.events, borderColor: 'orange' }
                    ]
                }
            });
        });
        renderChartWithRetry(fraudId, (el) => {
            return new Chart(el, {
                type: 'line',
                data: {
                    labels: app.dates,
                    datasets: [
                        { label: 'Blocked Installs', data: app.blocked_installs, borderColor: 'purple' }
                    ]
                }
            });
        });
    });
} 