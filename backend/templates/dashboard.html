<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AppsFlyer Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab-button.active {
            background-color: #4F46E5;
            color: white;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4F46E5;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .progress-bar {
            width: 100%;
            height: 4px;
            background-color: #f3f3f3;
            border-radius: 2px;
            overflow: hidden;
            display: none;
        }
        .progress-bar-fill {
            height: 100%;
            background-color: #4F46E5;
            width: 0%;
            transition: width 0.3s ease;
        }
        /* Stats Table Improvements */
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.92rem;
            margin-bottom: 1.2rem;
            background: #fff;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
        }
        .stats-table th, .stats-table td {
            padding: 0.28rem 0.13rem;
            border: 1px solid #e5e7eb;
            text-align: right;
            white-space: nowrap;
        }
        .stats-table th {
            background: #f3f4f6;
            font-weight: bold;
            color: #22223b;
            text-align: center;
        }
        .stats-table th.app-header {
            background: #e0e7ff;
            color: #3730a3;
            font-size: 1.1rem;
            text-align: left;
            padding-left: 1rem;
        }
        .stats-table td:first-child, .stats-table th:first-child {
            text-align: left !important;
            padding-left: 0.7rem;
            position: sticky;
            left: 0;
            background: #fff;
            z-index: 2;
            box-shadow: 2px 0 6px -2px rgba(60,60,100,0.10);
        }
        .stats-table th:first-child {
            background: #e0e7ff;
            z-index: 3;
            box-shadow: 2px 0 8px -2px rgba(60,60,100,0.13);
        }
        .stats-table {
            min-width: 900px;
        }
        .stats-table-container {
            overflow-x: auto;
            width: 100%;
        }
        .app-card {
            border: 1.5px solid #e5e7eb;
            border-radius: 1rem;
            margin-bottom: 2.5rem;
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            padding: 2rem 1.5rem 2.5rem 1.5rem;
            transition: box-shadow 0.2s;
        }
        .app-card:hover {
            box-shadow: 0 6px 24px rgba(80,80,180,0.10);
        }
        .trend-graph {
            height: 260px;
            margin-top: 2.2rem;
        }
        @media (max-width: 900px) {
          .fraud-graph-container { min-width: 180px !important; }
        }
        @media (max-width: 600px) {
          .fraud-graph-container { min-width: 120px !important; }
        }
        /* Sticky metric column for stats table */
        .sticky-metric-col {
          position: sticky;
          left: 0;
          background: #eef2ff !important; /* indigo-50 */
          z-index: 3;
          border-right: 2px solid #e0e7ff;
          min-width: 120px;
          max-width: 220px;
          box-shadow: 2px 0 8px -2px rgba(60,60,100,0.10);
        }
        .fraud-app-card { background: #f8fafc; border-radius: 1rem; margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(80,80,180,0.06); border: 1.5px solid #e0e7ff; }
        .fraud-app-header { background: #e0e7ff; color: #3730a3; font-size: 1.1rem; font-weight: bold; border-radius: 1rem 1rem 0 0; padding: 1rem 1.5rem; border-bottom: 1.5px solid #c7d2fe; }
        .fraud-table { width: 100%; border-collapse: separate; border-spacing: 0; background: #fff; border-radius: 0 0 1rem 1rem; overflow: hidden; }
        .fraud-table th { background: #f1f5f9; color: #334155; font-weight: 700; font-size: 0.95rem; padding: 0.7rem 1rem; text-align: left; }
        .fraud-table th.fraud-center, .fraud-table td.fraud-center { text-align: center !important; }
        .fraud-table td { padding: 0.7rem 1rem; font-size: 1rem; border-bottom: 1px solid #f1f5f9; }
        .fraud-table tr:last-child td { border-bottom: none; }
        .fraud-media-source { font-family: 'Menlo', 'Consolas', monospace; font-weight: 500; color: #475569; }
        .fraud-badge-pa { background: #fee2e2; color: #dc2626; font-weight: bold; border-radius: 9999px; padding: 0.25em 0.9em; font-size: 1rem; display: inline-block; }
        .fraud-badge-rt { background: #fef9c3; color: #ca8a04; font-weight: bold; border-radius: 9999px; padding: 0.25em 0.9em; font-size: 1rem; display: inline-block; }
        .fraud-table tr:nth-child(even) { background: #f9fafb; }
        .fraud-table tr:hover { background: #e0e7ff22; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">AppsFlyer Dashboard</h1>
            <div class="flex items-center space-x-2">
                <button onclick="switchTab('profile')" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">Profile</button>
                <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg">
                    Logout
                </button>
            </div>
        </div>
        <!-- test -->
        <!-- Tabs -->
        <div class="mb-8">
            <div class="flex space-x-4 border-b border-gray-200">
                <button class="tab-button active px-4 py-2 rounded-t-lg" onclick="switchTab('overview')">
                    Overview
                </button>
                <button class="tab-button px-4 py-2 rounded-t-lg" onclick="switchTab('apps')">
                    Apps
                </button>
                <button class="tab-button px-4 py-2 rounded-t-lg" onclick="switchTab('stats')">
                    Stats
                </button>
                <button class="tab-button px-4 py-2 rounded-t-lg" onclick="switchTab('fraud')">
                    Fraud
                </button>
                <button class="tab-button px-4 py-2 rounded-t-lg" onclick="switchTab('profile')">
                    Profile
                </button>
            </div>
        </div>

        <!-- Overview Tab Content -->
        <div id="overview-tab" class="tab-content active">
            <div class="flex justify-end mb-4">
                <button id="refresh-overview-btn" class="border border-blue-400 text-blue-600 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-blue-50 transition">Refresh Overview</button>
            </div>
            <div class="space-y-12"> <!-- Add vertical spacing between cards -->
                <!-- Total Performance Card -->
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-extrabold text-gray-900 flex items-center">Total Performance <span class="text-xs text-gray-400 font-normal ml-4" id="overview-last-updated"></span></h2>
                    </div>
                    <div class="bg-gradient-to-br from-gray-50 to-white rounded-xl p-6 shadow mb-6">
                        <div class="flex flex-col md:flex-row gap-6 justify-center items-stretch">
                            <div class="bg-white border border-gray-200 rounded-xl p-4 flex-1 min-w-0 flex flex-col items-center shadow-sm">
                                <div class="text-sm font-semibold text-indigo-700 mb-2 text-center">Impressions</div>
                                <canvas id="impressionsChart" height="220" style="max-height:220px;"></canvas>
                            </div>
                            <div class="bg-white border border-gray-200 rounded-xl p-4 flex-1 min-w-0 flex flex-col items-center shadow-sm">
                                <div class="text-sm font-semibold text-green-700 mb-2 text-center">Clicks</div>
                                <canvas id="clicksChart" height="220" style="max-height:220px;"></canvas>
                            </div>
                            <div class="bg-white border border-gray-200 rounded-xl p-4 flex-1 min-w-0 flex flex-col items-center shadow-sm">
                                <div class="text-sm font-semibold text-orange-700 mb-2 text-center">Installs</div>
                                <canvas id="installsChart" height="220" style="max-height:220px;"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="text-xs text-gray-500 mt-2 text-center">Data reflects the last run of the <b>Last 10 Days</b> report on the Stats page.</div>
                </div>
                <!-- Top Fraudulent Sources Card -->
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <h3 class="text-2xl font-extrabold text-gray-900 mb-4 flex items-center">Top Fraudulent Sources <span class="text-xs text-gray-400 font-normal ml-4" id="fraud-last-updated"></span></h3>
                    <div class="overflow-x-auto">
                        <style>
                        .fraud-app-card { background: #f8fafc; border-radius: 1rem; margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(80,80,180,0.06); border: 1.5px solid #e0e7ff; }
                        .fraud-app-header { background: #e0e7ff; color: #3730a3; font-size: 1.1rem; font-weight: bold; border-radius: 1rem 1rem 0 0; padding: 1rem 1.5rem; border-bottom: 1.5px solid #c7d2fe; }
                        .fraud-table { width: 100%; border-collapse: separate; border-spacing: 0; background: #fff; border-radius: 0 0 1rem 1rem; overflow: hidden; }
                        .fraud-table th { background: #f1f5f9; color: #334155; font-weight: 700; font-size: 0.95rem; padding: 0.7rem 1rem; text-align: left; }
                        .fraud-table th.fraud-center, .fraud-table td.fraud-center { text-align: center !important; }
                        .fraud-table td { padding: 0.7rem 1rem; font-size: 1rem; border-bottom: 1px solid #f1f5f9; }
                        .fraud-table tr:last-child td { border-bottom: none; }
                        .fraud-media-source { font-family: 'Menlo', 'Consolas', monospace; font-weight: 500; color: #475569; }
                        .fraud-badge-pa { background: #fee2e2; color: #dc2626; font-weight: bold; border-radius: 9999px; padding: 0.25em 0.9em; font-size: 1rem; display: inline-block; }
                        .fraud-badge-rt { background: #fef9c3; color: #ca8a04; font-weight: bold; border-radius: 9999px; padding: 0.25em 0.9em; font-size: 1rem; display: inline-block; }
                        .fraud-table tr:nth-child(even) { background: #f9fafb; }
                        .fraud-table tr:hover { background: #e0e7ff22; }
                        </style>
                        <div id="bad-sources-list"></div>
                        <div id="bad-sources-empty" class="text-center text-gray-400 text-sm mt-4" style="display:none;">No fraud data available. Please run the 'Fraud Per Source' report for the last 10 days.</div>
                    </div>
                </div>
                <!-- Top Performing Apps Card -->
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <h3 class="text-2xl font-extrabold text-gray-900 mb-4 flex items-center">Top Performing Apps <span class="text-xs text-gray-400 font-normal ml-4" id="top-apps-last-updated"></span></h3>
                    <div class="overflow-x-auto">
                        <div class="fraud-app-card">
                            <table class="fraud-table">
                                <thead>
                                    <tr>
                                        <th>App Name</th>
                                        <th class="fraud-center" id="event1-header">Event 1</th>
                                        <th class="fraud-center" id="event2-header">Event 2</th>
                                        <th class="fraud-center">Total Events</th>
                                    </tr>
                                </thead>
                                <tbody id="top-apps-list">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <!-- Clear Backend Data Button (moved to bottom, smaller) -->
                <div class="flex justify-center mt-8 mb-2">
                    <button id="clear-backend-cache-btn" class="border border-red-400 text-red-600 px-3 py-1 rounded text-xs font-semibold hover:bg-red-50 transition">Clear Backend Data</button>
                </div>
            </div>
        </div>

        <!-- Apps Tab Content -->
        <div id="apps-tab" class="tab-content">
            <div class="flex justify-end mb-4">
                <button id="refresh-apps-btn" class="border border-blue-400 text-blue-600 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-blue-50 transition">Refresh</button>
            </div>
            <div class="bg-white rounded-2xl shadow-xl p-10">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-extrabold text-gray-900 flex items-center">Active Apps</h2>
                    <div class="flex items-center space-x-4">
                        <div class="text-xs text-gray-400 font-normal" id="apps-last-updated"></div>
                        <button id="get-apps-btn" onclick="fetchApps()" 
                                class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg flex items-center shadow-md transition">
                            <span>Get Apps</span>
                            <div class="loading-spinner ml-2"></div>
                        </button>
                        <button id="get-events-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg flex items-center relative shadow-md transition">
                            <span>Get Events</span>
                            <div id="get-events-spinner" class="loading-spinner ml-2" style="display:none;"></div>
                            <span id="get-events-timer" class="ml-2 text-xs text-gray-400"></span>
                        </button>
                    </div>
                </div>
                <div class="progress-bar mb-4">
                    <div class="progress-bar-fill"></div>
                </div>
                <div class="mb-6">
                    <p class="text-gray-600 text-lg">Total Active Apps: <span id="app-count" class="font-bold text-indigo-700">0</span></p>
                </div>
                <div class="overflow-x-auto rounded-xl shadow">
                    <table class="min-w-full bg-white rounded-xl overflow-hidden shadow-lg">
                        <thead class="bg-indigo-50">
                            <tr>
                                <th class="py-4 px-6 text-left text-gray-700 font-bold text-sm uppercase tracking-wider">App ID</th>
                                <th class="py-4 px-6 text-left text-gray-700 font-bold text-sm uppercase tracking-wider">App Name</th>
                                <th class="py-4 px-6 text-left text-gray-700 font-bold text-sm uppercase tracking-wider">Event 1</th>
                                <th class="py-4 px-6 text-left text-gray-700 font-bold text-sm uppercase tracking-wider">Event 2</th>
                                <th class="py-4 px-6 text-left text-gray-700 font-bold text-sm uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="apps-list" class="divide-y divide-gray-100">
                            <!-- Apps will be populated here -->
                        </tbody>
                    </table>
                </div>
                <div class="flex justify-end mt-8">
                    <button id="save-all-events-btn" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-xl text-lg font-bold shadow-lg transition">SAVE ALL</button>
                </div>
                <div class="flex justify-center mt-8 mb-2">
                    <button id="clear-apps-cache-btn" class="border border-red-400 text-red-600 px-3 py-1 rounded text-xs font-semibold hover:bg-red-50 transition">Clear Apps Cache</button>
                </div>
            </div>
        </div>

        <!-- Stats Tab Content -->
        <div id="stats-tab" class="tab-content">
            <div class="flex justify-end mb-4">
                <button id="refresh-stats-btn" class="border border-blue-400 text-blue-600 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-blue-50 transition">Refresh</button>
            </div>
            <div class="bg-white rounded-2xl shadow-xl p-10">
                <h2 class="text-3xl font-extrabold text-gray-900 mb-8">Stats</h2>
                <!-- Date Range Tabs -->
                <div class="flex border-b border-gray-200 mb-8 gap-2">
                    <button class="date-range-tab px-6 py-2 rounded-full font-semibold text-sm border-2 border-gray-200 bg-gray-50 hover:bg-green-100 transition" data-range="10d">Last 10 Days</button>
                    <button class="date-range-tab px-6 py-2 rounded-full font-semibold text-sm border-2 border-gray-200 bg-gray-50 hover:bg-green-100 transition" data-range="mtd">Month to Date</button>
                    <button class="date-range-tab px-6 py-2 rounded-full font-semibold text-sm border-2 border-gray-200 bg-gray-50 hover:bg-green-100 transition" data-range="lastmonth">Last Month</button>
                    <button class="date-range-tab px-6 py-2 rounded-full font-semibold text-sm border-2 border-gray-200 bg-gray-50 hover:bg-green-100 transition" data-range="30d">Last 30 Days</button>
                </div>
                <!-- Sub-tab content containers -->
                <div id="stats-content-10d" class="stats-range-content" style="display:none;">
                    <button id="run-report-10d-btn" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-xl text-lg font-bold shadow-lg mb-6 transition">RUN REPORT</button>
                    <div id="stats-data-10d" class="space-y-10"></div>
                </div>
                <div id="stats-content-mtd" class="stats-range-content" style="display:none;">
                    <button id="run-report-mtd-btn" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-xl text-lg font-bold shadow-lg mb-6 transition">RUN REPORT</button>
                    <div id="stats-data-mtd" class="space-y-10"></div>
                </div>
                <div id="stats-content-lastmonth" class="stats-range-content" style="display:none;">
                    <button id="run-report-lastmonth-btn" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-xl text-lg font-bold shadow-lg mb-6 transition">RUN REPORT</button>
                    <div id="stats-data-lastmonth" class="space-y-10"></div>
                </div>
                <div id="stats-content-30d" class="stats-range-content" style="display:none;">
                    <button id="run-report-30d-btn" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-xl text-lg font-bold shadow-lg mb-6 transition">RUN REPORT</button>
                    <div id="stats-data-30d"></div>
                </div>
                <div id="stats-loading" class="text-center text-gray-500 mt-8" style="display:none;">
                    Loading stats...
                </div>
                <div id="stats-error" class="text-center text-red-500 mt-8" style="display:none;">
                    Error loading stats.
                </div>
                <div class="flex justify-center mt-8 mb-2">
                    <button id="clear-stats-cache-btn" class="border border-red-400 text-red-600 px-3 py-1 rounded text-xs font-semibold hover:bg-red-50 transition">Clear Stats Cache</button>
                </div>
            </div>
        </div>

        <!-- Fraud Tab Content -->
        <div id="fraud-tab" class="tab-content">
            <div class="flex justify-end mb-4">
                <button id="refresh-fraud-btn" class="border border-blue-400 text-blue-600 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-blue-50 transition">Refresh</button>
            </div>
            <div class="bg-white rounded-lg shadow-lg p-8 max-w-5xl mx-auto">
                <!-- Sub-tabs for Fraud Analytics and Fraud Per Source -->
                <div class="flex space-x-4 mb-6">
                    <button id="fraud-analytics-tab-btn" class="subtab-button border-b-2 border-blue-500 text-blue-600 font-semibold px-4 py-2" onclick="switchFraudSubTab('analytics')">Fraud Analytics</button>
                    <button id="fraud-source-tab-btn" class="subtab-button border-b-2 border-transparent text-gray-500 font-semibold px-4 py-2" onclick="switchFraudSubTab('source')">Fraud Per Source</button>
                </div>
                <!-- Fraud Analytics Sub-page -->
                <div id="fraud-analytics-subtab">
                    <h2 class="text-3xl font-bold text-gray-800 mb-8">Fraud Analytics</h2>
                    <!-- Date Range Tabs -->
                    <div class="flex border-b border-gray-200 mb-8 gap-2">
                        <button class="fraud-range-tab px-6 py-2 rounded-full font-semibold text-sm border-2 border-gray-200 bg-gray-50 hover:bg-green-100 transition" data-range="10d">Last 10 Days</button>
                        <button class="fraud-range-tab px-6 py-2 rounded-full font-semibold text-sm border-2 border-gray-200 bg-gray-50 hover:bg-green-100 transition" data-range="mtd">Month to Date</button>
                        <button class="fraud-range-tab px-6 py-2 rounded-full font-semibold text-sm border-2 border-gray-200 bg-gray-50 hover:bg-green-100 transition" data-range="lastmonth">Last Month</button>
                        <button class="fraud-range-tab px-6 py-2 rounded-full font-semibold text-sm border-2 border-gray-200 bg-gray-50 hover:bg-green-100 transition" data-range="30d">Last 30 Days</button>
                    </div>
                    <!-- Sub-tab content containers -->
                    <div id="fraud-content-10d" class="fraud-range-content" style="display:none;">
                        <button id="run-fraud-10d-btn" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-xl text-lg font-bold shadow-lg mb-6 transition">RUN REPORT</button>
                        <div id="fraud-data-10d"></div>
                    </div>
                    <div id="fraud-content-mtd" class="fraud-range-content" style="display:none;">
                        <button id="run-fraud-mtd-btn" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-xl text-lg font-bold shadow-lg mb-6 transition">RUN REPORT</button>
                        <div id="fraud-data-mtd"></div>
                    </div>
                    <div id="fraud-content-lastmonth" class="fraud-range-content" style="display:none;">
                        <button id="run-fraud-lastmonth-btn" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-xl text-lg font-bold shadow-lg mb-6 transition">RUN REPORT</button>
                        <div id="fraud-data-lastmonth"></div>
                    </div>
                    <div id="fraud-content-30d" class="fraud-range-content" style="display:none;">
                        <button id="run-fraud-30d-btn" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-xl text-lg font-bold shadow-lg mb-6 transition">RUN REPORT</button>
                        <div id="fraud-data-30d"></div>
                    </div>
                    <div id="fraud-loading" class="text-center text-gray-500 mt-8" style="display:none;">
                        Loading fraud data...
                    </div>
                    <div id="fraud-error" class="text-center text-red-500 mt-8" style="display:none;">
                        Error loading fraud data.
                    </div>
                </div>
                <!-- Fraud Per Source Sub-page -->
                <div id="fraud-source-subtab" style="display:none;">
                    <h2 class="text-3xl font-bold text-gray-800 mb-8">Fraud Per Source</h2>
                    <!-- Date Range Tabs -->
                    <div class="flex border-b border-gray-200 mb-8 gap-2">
                        <button class="fraud-source-range-tab px-6 py-2 rounded-full font-semibold text-sm border-2 border-gray-200 bg-gray-50 hover:bg-green-100 transition" data-range="10d">Last 10 Days</button>
                        <button class="fraud-source-range-tab px-6 py-2 rounded-full font-semibold text-sm border-2 border-gray-200 bg-gray-50 hover:bg-green-100 transition" data-range="mtd">Month to Date</button>
                        <button class="fraud-source-range-tab px-6 py-2 rounded-full font-semibold text-sm border-2 border-gray-200 bg-gray-50 hover:bg-green-100 transition" data-range="lastmonth">Last Month</button>
                        <button class="fraud-source-range-tab px-6 py-2 rounded-full font-semibold text-sm border-2 border-gray-200 bg-gray-50 hover:bg-green-100 transition" data-range="30d">Last 30 Days</button>
                    </div>
                    <!-- Sub-tab content containers -->
                    <div id="fraud-source-content-10d" class="fraud-source-range-content" style="display:none;">
                        <button id="run-fraud-source-10d-btn" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-xl text-lg font-bold shadow-lg mb-6 transition">RUN REPORT</button>
                        <div id="fraud-source-loading-10d" class="text-center text-gray-500 mt-8" style="display:none;">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-gray-300 border-t-green-600 mb-2"></div>
                            <div>Loading fraud data...</div>
                        </div>
                        <div id="fraud-source-error-10d" class="text-center text-red-500 mt-8 p-4 bg-red-50 rounded-lg" style="display:none;">
                            Error loading fraud data. Please try again.
                        </div>
                        <div id="fraud-source-data-10d"></div>
                    </div>
                    <div id="fraud-source-content-mtd" class="fraud-source-range-content" style="display:none;">
                        <button id="run-fraud-source-mtd-btn" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-xl text-lg font-bold shadow-lg mb-6 transition">RUN REPORT</button>
                        <div id="fraud-source-loading-mtd" class="text-center text-gray-500 mt-8" style="display:none;">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-gray-300 border-t-green-600 mb-2"></div>
                            <div>Loading fraud data...</div>
                        </div>
                        <div id="fraud-source-error-mtd" class="text-center text-red-500 mt-8 p-4 bg-red-50 rounded-lg" style="display:none;">
                            Error loading fraud data. Please try again.
                        </div>
                        <div id="fraud-source-data-mtd"></div>
                    </div>
                    <div id="fraud-source-content-lastmonth" class="fraud-source-range-content" style="display:none;">
                        <button id="run-fraud-source-lastmonth-btn" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-xl text-lg font-bold shadow-lg mb-6 transition">RUN REPORT</button>
                        <div id="fraud-source-loading-lastmonth" class="text-center text-gray-500 mt-8" style="display:none;">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-gray-300 border-t-green-600 mb-2"></div>
                            <div>Loading fraud data...</div>
                        </div>
                        <div id="fraud-source-error-lastmonth" class="text-center text-red-500 mt-8 p-4 bg-red-50 rounded-lg" style="display:none;">
                            Error loading fraud data. Please try again.
                        </div>
                        <div id="fraud-source-data-lastmonth"></div>
                    </div>
                    <div id="fraud-source-content-30d" class="fraud-source-range-content" style="display:none;">
                        <button id="run-fraud-source-30d-btn" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-xl text-lg font-bold shadow-lg mb-6 transition">RUN REPORT</button>
                        <div id="fraud-source-loading-30d" class="text-center text-gray-500 mt-8" style="display:none;">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-gray-300 border-t-green-600 mb-2"></div>
                            <div>Loading fraud data...</div>
                        </div>
                        <div id="fraud-source-error-30d" class="text-center text-red-500 mt-8 p-4 bg-red-50 rounded-lg" style="display:none;">
                            Error loading fraud data. Please try again.
                        </div>
                        <div id="fraud-source-data-30d"></div>
                    </div>
                    <div id="fraud-source-loading" class="text-center text-gray-500 mt-8" style="display:none;">
                        Loading fraud per source data...
                    </div>
                    <div id="fraud-source-error" class="text-center text-red-500 mt-8" style="display:none;">
                        Error loading fraud per source data.
                    </div>
                </div>
                <div class="flex justify-center mt-8 mb-2">
                    <button id="clear-fraud-cache-btn" class="border border-red-400 text-red-600 px-3 py-1 rounded text-xs font-semibold hover:bg-red-50 transition">Clear Fraud Cache</button>
                </div>
            </div>
        </div>

        <!-- Profile Tab Content -->
        <div id="profile-tab" class="tab-content">
            <div class="bg-white rounded-lg shadow-lg p-8 max-w-lg mx-auto">
                <h2 class="text-3xl font-bold text-gray-800 mb-8">Profile</h2>
                <div class="space-y-6">
                    <div>
                        <div class="text-gray-500 text-xs uppercase tracking-wider mb-1">Agency Account</div>
                        <div class="flex items-center space-x-2">
                            <span id="agency-name" class="text-lg font-semibold text-gray-900">N/A</span>
                            <button id="edit-agency-btn" class="text-blue-600 hover:underline text-sm">Edit</button>
                        </div>
                        <div id="agency-edit" class="flex items-center space-x-2 mt-2" style="display:none;">
                            <input id="agency-input" type="text" class="border rounded px-2 py-1 text-sm flex-1" style="min-width:120px;">
                            <button id="save-agency-btn" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-xs">Save</button>
                            <button id="cancel-agency-btn" class="text-gray-500 px-3 py-1 rounded text-xs">Cancel</button>
                        </div>
                    </div>
                    <div>
                        <div class="text-gray-500 text-xs uppercase tracking-wider mb-1">API Key</div>
                        <div class="flex items-center space-x-2">
                            <span id="api-key" class="font-mono text-base text-gray-900 truncate" style="max-width: 180px; display: inline-block;">N/A</span>
                            <button id="edit-api-key-btn" class="text-blue-600 hover:underline text-sm">Edit</button>
                        </div>
                        <div id="api-key-edit" class="flex items-center space-x-2 mt-2" style="display:none;">
                            <input id="api-key-input" type="text" class="border rounded px-2 py-1 text-sm font-mono flex-1" style="min-width:120px;">
                            <button id="save-api-key-btn" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-xs">Save</button>
                            <button id="cancel-api-key-btn" class="text-gray-500 px-3 py-1 rounded text-xs">Cancel</button>
                        </div>
                    </div>
                    <div>
                        <div class="text-gray-500 text-xs uppercase tracking-wider mb-1">User/Email</div>
                        <div class="flex items-center space-x-2">
                            <span id="user-email" class="font-mono text-base text-gray-900">N/A</span>
                            <button id="edit-user-email-btn" class="text-blue-600 hover:underline text-sm">Edit</button>
                        </div>
                        <div id="user-email-edit" class="flex items-center space-x-2 mt-2" style="display:none;">
                            <input id="user-email-input" type="text" class="border rounded px-2 py-1 text-sm font-mono flex-1" style="min-width:120px;">
                            <button id="save-user-email-btn" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-xs">Save</button>
                            <button id="cancel-user-email-btn" class="text-gray-500 px-3 py-1 rounded text-xs">Cancel</button>
                        </div>
                    </div>
                    <div>
                        <div class="text-gray-500 text-xs uppercase tracking-wider mb-1">Password</div>
                        <div class="flex items-center space-x-2">
                            <span id="user-password" class="font-mono text-base text-gray-900">••••••••</span>
                            <button id="edit-user-password-btn" class="text-blue-600 hover:underline text-sm">Edit</button>
                        </div>
                        <div id="user-password-edit" class="flex items-center space-x-2 mt-2" style="display:none;">
                            <input id="user-password-input" type="password" class="border rounded px-2 py-1 text-sm font-mono flex-1" style="min-width:120px;">
                            <button id="save-user-password-btn" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-xs">Save</button>
                            <button id="cancel-user-password-btn" class="text-gray-500 px-3 py-1 rounded text-xs">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // At the top of the <script> section, add:
        window._chartInstances = window._chartInstances || {};

        // Fallback for fetchedApps
        window.fetchedApps = window.fetchedApps || [];

        // Add a helper to disable/enable all fetch buttons
        function setFetchButtonsDisabled(disabled) {
            document.getElementById('get-apps-btn').disabled = disabled;
            document.getElementById('get-events-btn').disabled = disabled;
            document.querySelectorAll('.date-range-tab').forEach(btn => btn.disabled = disabled);
            document.querySelectorAll('[id^="run-report-"]').forEach(btn => btn.disabled = disabled);
        }

        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Deactivate all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Activate selected tab button
            event.target.classList.add('active');
        }

        // Remove static apps and update fetchApps
        fetchApps = function() {
            setFetchButtonsDisabled(true);
            const button = document.getElementById('get-apps-btn');
            button.innerHTML = '<span class="animate-spin">⌛</span> Loading...';
            fetch('/get_apps')
                .then(response => response.text())
                .then(text => {
                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch (e) {
                        setFetchButtonsDisabled(false);
                        button.innerHTML = 'Get Apps';
                        document.getElementById('app-count').textContent = 'The data is being prepared. Please wait.';
                        return;
                    }
                    if (data.status === 'processing') {
                        setFetchButtonsDisabled(false);
                        button.innerHTML = 'Get Apps';
                        document.getElementById('app-count').textContent = "Hang tight! The system's doing its thing. Just a couple more minutes and your stats will magically appear!";
                        setTimeout(fetchApps, 30000);
                        return;
                    }
                    setFetchButtonsDisabled(false);
                    button.innerHTML = 'Get Apps';
                    if (data.error) {
                        document.getElementById('app-count').textContent = `Error: ${data.error}`;
                        return;
                    }
                    fetchedApps = data.apps;
                    renderAppsList(fetchedApps);
                    document.getElementById('app-count').textContent = data.count;
                    document.getElementById('apps-last-updated').textContent = data.fetch_time ? `(Last updated: ${data.fetch_time})` : '';
                })
                .catch(error => {
                    setFetchButtonsDisabled(false);
                    button.innerHTML = 'Get Apps';
                    document.getElementById('app-count').textContent = `Error: ${error.message}`;
                });
        }

        function logout() {
            fetch('/logout')
                .then(() => {
                    window.location.href = '/';
                });
        }

        // Check authentication status
        function checkAuth() {
            fetch('/check-auth')
                .then(response => {
                    if (!response.ok) {
                        window.location.href = '/';
                    }
                });
        }

        // Check auth status periodically
        setInterval(checkAuth, 30000);
        checkAuth();

        // --- Stats Tab Logic ---
        // Persistent stats data for each range
        const statsData = {
            '10d': null,
            'mtd': null,
            'lastmonth': null,
            '30d': null
        };

        // Date range tab logic
        const dateRanges = ['10d','mtd','lastmonth','30d'];
        // Patch switchStatsRangeTab to always render data for the active range if available
        function switchStatsRangeTab(range) {
            document.querySelectorAll('.date-range-tab').forEach(btn => {
                btn.classList.remove('border-green-600','text-green-700','bg-white');
                btn.classList.add('border-transparent','text-gray-500','hover:text-green-700','hover:border-green-400');
            });
            document.querySelector(`.date-range-tab[data-range="${range}"]`).classList.remove('border-transparent','text-gray-500','hover:text-green-700','hover:border-green-400');
            document.querySelector(`.date-range-tab[data-range="${range}"]`).classList.add('border-green-600','text-green-700','bg-white');
            document.querySelectorAll('.stats-range-content').forEach(div => div.style.display = 'none');
            document.getElementById(`stats-content-${range}`).style.display = '';
            // Always render data for the active range if available
            if (statsData[range] && statsData[range].apps) {
                renderStatsAppsForRange(range, statsData[range].apps || []);
            }
        }
        document.querySelectorAll('.date-range-tab').forEach(btn => {
            btn.onclick = function() {
                    setTimeout(() => {
                        refreshStatsBtn.textContent = 'Refresh';
                        refreshStatsBtn.disabled = false;
                    }, 1200);
                };
            }
            // Add Refresh Fraud button logic
            const refreshFraudBtn = document.getElementById('refresh-fraud-btn');
            if (refreshFraudBtn) {
                refreshFraudBtn.onclick = function() {
                    refreshFraudBtn.disabled = true;
                    refreshFraudBtn.textContent = 'Refreshing...';
                    // Re-run the currently selected fraud report
                    const activeFraudRangeBtn = document.querySelector('.fraud-range-tab.border-green-600');
                    let range = '10d';
                    if (activeFraudRangeBtn) range = activeFraudRangeBtn.getAttribute('data-range');
                    document.getElementById(`run-fraud-${range}-btn`).onclick();
                    setTimeout(() => {
                        refreshFraudBtn.textContent = 'Refresh';
                        refreshFraudBtn.disabled = false;
                    }, 1200);
                };
            }
            // Add Clear Apps Cache button logic
            const clearAppsBtn = document.getElementById('clear-apps-cache-btn');
            if (clearAppsBtn) {
                clearAppsBtn.onclick = function() {
                    if (!confirm('Are you sure you want to clear the apps cache?')) return;
                    clearAppsBtn.disabled = true;
                    clearAppsBtn.textContent = 'Clearing...';
                    fetch('/clear-apps-cache', { method: 'POST' })
                        .then(r => r.json())
                        .then(data => {
                            clearAppsBtn.textContent = data.success ? 'Cache Cleared!' : 'Failed to Clear';
                            setTimeout(() => {
                                clearAppsBtn.textContent = 'Clear Apps Cache';
                                clearAppsBtn.disabled = false;
                            }, 1500);
                        })
                        .catch(() => {
                            clearAppsBtn.textContent = 'Error';
                            setTimeout(() => {
                                clearAppsBtn.textContent = 'Clear Apps Cache';
                                clearAppsBtn.disabled = false;
                            }, 1500);
                        });
                };
            }
            // Add Clear Stats Cache button logic
            const clearStatsBtn = document.getElementById('clear-stats-cache-btn');
            if (clearStatsBtn) {
                clearStatsBtn.onclick = function() {
                    if (!confirm('Are you sure you want to clear the stats cache?')) return;
                    clearStatsBtn.disabled = true;
                    clearStatsBtn.textContent = 'Clearing...';
                    fetch('/clear-stats-cache', { method: 'POST' })
                        .then(r => r.json())
                        .then(data => {
                            clearStatsBtn.textContent = data.success ? 'Cache Cleared!' : 'Failed to Clear';
                            setTimeout(() => {
                                clearStatsBtn.textContent = 'Clear Stats Cache';
                                clearStatsBtn.disabled = false;
                            }, 1500);
                        })
                        .catch(() => {
                            clearStatsBtn.textContent = 'Error';
                            setTimeout(() => {
                                clearStatsBtn.textContent = 'Clear Stats Cache';
                                clearStatsBtn.disabled = false;
                            }, 1500);
                        });
                };
            }
            // Add Clear Fraud Cache button logic
            const clearFraudBtn = document.getElementById('clear-fraud-cache-btn');
            if (clearFraudBtn) {
                clearFraudBtn.onclick = function() {
                    if (!confirm('Are you sure you want to clear the fraud cache?')) return;
                    clearFraudBtn.disabled = true;
                    clearFraudBtn.textContent = 'Clearing...';
                    fetch('/clear-fraud-cache', { method: 'POST' })
                        .then(r => r.json())
                        .then(data => {
                            clearFraudBtn.textContent = data.success ? 'Cache Cleared!' : 'Failed to Clear';
                            setTimeout(() => {
                                clearFraudBtn.textContent = 'Clear Fraud Cache';
                                clearFraudBtn.disabled = false;
                            }, 1500);
                        })
                        .catch(() => {
                            clearFraudBtn.textContent = 'Error';
                            setTimeout(() => {
                                clearFraudBtn.textContent = 'Clear Fraud Cache';
                                clearFraudBtn.disabled = false;
                            }, 1500);
                        });
                };
            }
        });

        // --- On page load or tab switch, always fetch and render cached data for all tabs and all ranges ---
        document.addEventListener('DOMContentLoaded', function() {
            // Overview
            if (document.getElementById('overview-tab')) fetchOverviewData();
            // Apps
            if (document.getElementById('apps-tab')) {
                fetch('/get_apps').then(r => r.json()).then(data => {
                    if (data && data.apps) {
                        window.fetchedApps = data.apps;
                        renderAppsList(data.apps);
                        document.getElementById('app-count').textContent = data.count;
                        document.getElementById('apps-last-updated').textContent = data.fetch_time ? `(Last updated: ${data.fetch_time})` : '';
                    }
                });
            }
            // Stats: fetch and render for all ranges, then render the active one
            if (document.getElementById('stats-tab')) {
                const statRanges = ['10d','mtd','lastmonth','30d'];
                const statRangeMap = { '10d': 'last10', 'mtd': 'mtd', 'lastmonth': 'lastmonth', '30d': 'last30' };
                let fetchedCount = 0;
                statRanges.forEach(range => {
                    fetch(`/get_stats?range=${statRangeMap[range]}`).then(r => r.json()).then(data => {
                        if (data && data.apps) {
                            statsData[range] = data;
                        }
                        fetchedCount++;
                        if (fetchedCount === statRanges.length) {
                            // After all ranges fetched, render the active one and force tab UI
                            const activeRange = getActiveStatsRange();
                            switchStatsRangeTab(activeRange);
                            if (statsData[activeRange]) {
                                renderStatsAppsForRange(activeRange, statsData[activeRange].apps || []);
                            }
                        }
                    });
                });
            }
            // Fraud: fetch and render for all ranges, then render the active one
            if (document.getElementById('fraud-tab')) {
                const fraudRanges = ['10d','mtd','lastmonth','30d'];
                const fraudPeriodMap = { '10d': 'last10', 'mtd': 'mtd', 'lastmonth': 'lastmonth', '30d': 'last30' };
                let fetchedCount = 0;
                fraudRanges.forEach(range => {
                    fetch('/get_fraud', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ apps: window.fetchedApps || [], period: fraudPeriodMap[range] })
                    }).then(r => r.json()).then(data => {
                        if (data && data.apps) {
                            fraudDataCache[range] = data;
                        }
                        fetchedCount++;
                        if (fetchedCount === fraudRanges.length) {
                            // After all ranges fetched, render the active one
                            const activeRange = getActiveFraudRange();
                            if (fraudDataCache[activeRange]) {
                                renderFraudAll(fraudDataCache[activeRange], activeRange);
                            }
                        }
                    });
                });
            }
            // Profile
            if (document.getElementById('profile-tab')) loadProfile();
        });

        // --- On tab switch, fetch and render cached data for all ranges of the selected tab ---
        const origSwitchTab5 = switchTab;
        switchTab = function(tabName) {
            origSwitchTab5(tabName);
            if (tabName === 'overview') fetchOverviewData();
            if (tabName === 'apps') {
                fetch('/get_apps').then(r => r.json()).then(data => {
                    if (data && data.apps) {
                        window.fetchedApps = data.apps;
                        renderAppsList(data.apps);
                        document.getElementById('app-count').textContent = data.count;
                        document.getElementById('apps-last-updated').textContent = data.fetch_time ? `(Last updated: ${data.fetch_time})` : '';
                    }
                });
            }
            if (tabName === 'stats') {
                const statRanges = ['10d','mtd','lastmonth','30d'];
                const statRangeMap = { '10d': 'last10', 'mtd': 'mtd', 'lastmonth': 'lastmonth', '30d': 'last30' };
                let fetchedCount = 0;
                statRanges.forEach(range => {
                    fetch(`/get_stats?range=${statRangeMap[range]}`).then(r => r.json()).then(data => {
                        if (data && data.apps) {
                            statsData[range] = data;
                        }
                        fetchedCount++;
                        if (fetchedCount === statRanges.length) {
                            const activeRange = getActiveStatsRange();
                            switchStatsRangeTab(activeRange);
                            if (statsData[activeRange]) {
                                renderStatsAppsForRange(activeRange, statsData[activeRange].apps || []);
                            }
                        }
                    });
                });
            }
            if (tabName === 'fraud') {
                const fraudRanges = ['10d','mtd','lastmonth','30d'];
                const fraudPeriodMap = { '10d': 'last10', 'mtd': 'mtd', 'lastmonth': 'lastmonth', '30d': 'last30' };
                let fetchedCount = 0;
                fraudRanges.forEach(range => {
                    fetch('/get_fraud', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ apps: window.fetchedApps || [], period: fraudPeriodMap[range] })
                    }).then(r => r.json()).then(data => {
                        if (data && data.apps) {
                            fraudDataCache[range] = data;
                        }
                        fetchedCount++;
                        if (fetchedCount === fraudRanges.length) {
                            const activeRange = getActiveFraudRange();
                            if (fraudDataCache[activeRange]) {
                                renderFraudAll(fraudDataCache[activeRange], activeRange);
                            }
                        }
                    });
                });
            }
            if (tabName === 'profile') loadProfile();
        };

        // Helper to get the currently active stats range
        function getActiveStatsRange() {
            const activeBtn = document.querySelector('.date-range-tab.border-green-600');
            return activeBtn ? activeBtn.getAttribute('data-range') : '10d';
        }
        // Helper to get the currently active fraud range
        function getActiveFraudRange() {
            const activeBtn = document.querySelector('.fraud-range-tab.border-green-600');
            return activeBtn ? activeBtn.getAttribute('data-range') : '10d';
        }
    </script>
</body>
</html> 